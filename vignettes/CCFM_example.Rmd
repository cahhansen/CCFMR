---
title: "CCFM Example"
author: "Carly Hansen"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{CCFM_Example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
# Traditional Change Factor Methodology (single and multiple CF)

## Setup

Load necessary libraries, and read in data and format by subsetting a specificed model into future and baseline periods. (Note that periods for the baseline and the observed dataset should be the same).

```{r}
#Load Libraries
library(CCFMR)
library(lubridate)

#Read in data
slcbcca=slc_bcca

#Limit data to specified time period for a specified model
baseperiod=c(1955,1984)
futureperiod=c(1985,2014)
base=formatperiods(slcbcca,"gfdl-esm2g.1.rcp26",baseperiod)
future=formatperiods(slcbcca,"gfdl-esm2g.1.rcp26",futureperiod)
obs=formatperiods(slc_obs,"ObservedPrecip",baseperiod)
 
comparison=formatperiods(slc_obs,"ObservedPrecip",futureperiod)

```

## Single Change Factor Approach

Calculate the additive and multiplicative change factors using the average daily values.
```{r}
#Find average precipitation volume for each day of the year
futureavg=avgdaily(future)
baseavg=avgdaily(base)
#Calculate additive and multiplicative change factors
add=calccf(baseavg,futureavg,cftype="additive")
mult=calccf(baseavg,futureavg,cftype="multiplicative")
```

Apply the change factors to the historical observations from the same time period as the baseline period.
```{r}
#Calculate the day of the year for observed data
obs$DOY=yday(obs$Date)

#Apply corresponding cf to observed dataset
scaledadd=scalesingle(add,obs,cftype="additive")
scaledmult=scalesingle(mult,obs,cftype="multiplicative")
```

## Multiple (100) Change Factor Approach

Calculate the change factor for each percentile from 1-100
```{r}
#Calculate the percentiles (ECDF) of modeled values
base=calcecdf(base,"Precip")
future=calcecdf(future,"Precip")

#Calculate the percentiles (ECDF) of the observed values
obs=calcecdf(obs,"Precip")

#Calculate the change factors by percentile
percent=data.frame(percentlow=seq(1,100))

for (i in seq(0,99)){
    percent$base[i+1]=mean(base[(base$percentlow==i),"Precip"])
    percent$future[i+1]=mean(future[(future$percentlow==i),"Precip"])
}
percent$base[is.nan(percent$base)]=0
percent$future[is.nan(percent$future)]=0

percent$addcf=percent$future-percent$base
percent$multcf=percent$future/percent$base
percent$multcf[is.nan(percent$multcf)]=0

#Visualize Results by plotting precip against the percentiles
plot(x=base$Precip,y=base$percentile,ylab='Percentile',xlab='Precipitation (mm/day)',main='ECDF',col=2)
points(x=future$Precip,y=future$percentile,col=4)
points(x=obs$Precip,y=obs$percentile,col=3)
```


Apply multiple change factors
```{r}
#Apply multiple change factors (additive and multiplicative only)
scaledma=scalemultiple(obs,"additive",percentdf=percent)
scaledma$modadd=scaledma$addscaled
scaledma[(scaledma$Precip==0),"modadd"]=0
scaledmm=scalemultiple(obs,"multiplicative",percentdf=percent)
```



# Combined Change Factor Methodology



Create Difference and Ratio Plots:
Following the suggestion of Anandhi, et al., use ratios and difference plots to determine which type of change factor might be the most appropriate (if there is a curve, large slope, or large variation over a range in one CF type, use the other type. If there is no difference, use default of the multiplicative).

```{r,fig.show='hold'}
#Calculate ratio and differences for each bin
diff=percent$future-percent$base
ratio=percent$future/percent$base

plot(x=diff,y=seq(1,100),xlab='Difference of Future-Baseline',ylab='Percentile')
plot(x=ratio,y=seq(1,100),xlab='Ratio of Future/Baseline',ylab='Percentile')
```


## CCFM - Single
```{r}
#Format a dataframe for the combined change factor method
scaledccfms=merge(obs,add,by="DOY")
scaledccfms=merge(scaledccfms,mult,by="DOY")
names(scaledccfms)=c("DOY","Date","Precip","percentile","percentlow","addcf","multcf")

```

Apply the change factor type for different ranges, using difference/ratio plots as a guide, and set a threshold for when the near-maxima values should use the additive change factor (regardless of difference/ratio plot results, which may not be very helpful near the maxima).
```{r}
#Apply the single change factors over the specified ranges
scaledccfms=ccfm(scaledccfms,"Precip","addcf","multcf",60,95)

#Remove extra precipitation events
scaledccfms[(scaledccfms$Precip==0),"scaled"]=0

```


## CCFM - Multiple

Apply the change factor type for different ranges, using difference/ratio plots as a guide, and set a threshold for when the near-maxima values should use the additive change factor (regardless of difference/ratio plot results, which may not be very helpful near the maxima).
```{r}
scaledccfmm=scaledmm

#Apply the multiple change factors over the specified ranges
scaledccfmm=ccfm(scaledccfmm,"Precip","addcf","multcf",60,95)

#Remove extra precipitation events
scaledccfmm[(scaledccfmm$Precip==0),"scaled"]=0
```

# Summary and Comparison of different methods

Calculate Summary Statistics to Compare Different Scaling Methods
```{r}
#Historical Observed
precipsummary(obs,"Precip",comparison,"Precip","Historical")

#Future Observed
precipsummary(comparison,"Precip",comparison,"Precip","Comparison")
#-----------------------------------------------------------
#Single Additive Change Factor
precipsummary(scaledadd,"scaled",comparison,"Precip","Single Additive")

#Single Multiplicative Change Factor
precipsummary(scaledmult,"scaled",comparison,"Precip","Single Multiplicative")

#Combined Single Change Factors
precipsummary(scaledccfms,"scaled",comparison,"Precip","Combined Single")
#------------------------------------------------------------
#Multiple Additive Change Factors
precipsummary(scaledma,"addscaled",comparison,"Precip","Multiple Additive")

#Multiple Additive Change Factors with modification
precipsummary(scaledma,"modadd",comparison,"Precip","Multiple Additive Mod")

#Multiple Multiplicative Change Factors
precipsummary(scaledmm,"multscaled",comparison,"Precip","Multiple Multiplicative")

#Combined Multiple Change Factors
precipsummary(scaledccfmm,"scaled",comparison,"Precip","Combined Multiple")

#Unscaled BCCA
precipsummary(future,"Precip",comparison,"Precip","Unscaled BCCA")

```

Plot scaled values

```{r}
scaledccfmm$FutureDate=scaledccfmm$Date+(round(365.25*40))
```
